<html>
<meta name="viewport" content="width=device-width, initial-scale=.9, user-scalable=no">
<meta name="theme-color" content="black" />
<head>
    <title>用戶變壓器定位</title>
    <script type="text/javascript" src="proj4.js"></script>
    <script type="text/javascript" src="./jquery-3.3.1.min.js"></script>

	<link id="theme" href="./style1.css" rel="stylesheet" tittle="style1">

    <style>
    	
    </style>

    <script>
        var latWGS84, lonWGS84, latTWD67TM2, lonTWD67TM2, gridTF;
		//rows = rows.concat(rowss);
        const idxLat = [
                       "2750000", "2750000", "2750000",
                       "2700000", "2700000", "2700000",
                       "2650000", "2650000", "2650000",
            "2600000", "2600000", "2600000",
            "2550000", "2550000", "2550000",
            "2500000", "2500000", "2500000",
            "2894000", "2450000", "2450000",
                       "2400000", "2400000",
            "2614000", "2564000", "2675800"
        ];
        const idxLon = [
                      "170000", "250000", "330000",
                      "170000", "250000", "330000",
                      "170000", "250000", "330000",
            "090000", "170000", "250000",
            "090000", "170000", "250000",
            "090000", "170000", "250000",
            "010000", "170000", "250000",
                      "170000", "250000",
            "275000", "275000", "010000" //"552700"
        ];
        const alphabet = [
                 "A", "B", "C",
                 "D", "E", "F",
                 "G", "H", "I",
            "J", "K", "L",
            "M", "N", "O",
            "P", "Q", "R",
            "S", "T", "U",
                 "V", "W",
            "X", "Y", "Z"
        ];
 
		function openGM() {
            var url = "https://www.google.com/maps/search/?api=1&query=" + latWGS84.toFixed(6) + "," + lonWGS84.toFixed(6);
            window.open(url, '_blank');
        }

        function openOSM() {
            var url = "http://osm.org/?" + "mlat=" + latWGS84 + "&" + "mlon=" + lonWGS84 + "&" + "#map=" + "17" + "/"+ latWGS84 + "/" + lonWGS84;
            window.open(url, '_blank');
        }

        function openNLSC() {
            var url = "https://maps.nlsc.gov.tw/go/" + latWGS84 + "/" + lonWGS84 + "/";
            window.open(url, '_blank');
        }

        function openLINE() {
            var url = "http://line.naver.jp/R/msg/text/?";
			var num = encodeURIComponent("電號：12-" + document.getElementById("customNum").value + "-" + document.getElementById("chkNum").value); 
			var pos = encodeURIComponent("座標：" + document.getElementById("inPole").value);
            var map = "https://www.google.com/maps/search/?api=1&query=" + latWGS84.toFixed(6) + "," + lonWGS84.toFixed(6);
            url += num + "%0D%0A" + pos + "%0D%0A" + map;
            
            window.open(url, '_blank');
        }

        function calcChkNum(){   
            document.getElementById("chkNum").value = "";       
            var cNum = document.getElementById("customNum").value.split("");
            var c10 = [2,1,2,1,2,1,2,1,2,1];
            
            if(cNum.length!=8) {
                document.getElementById("inPole").value = "";
                disableBtn();
                return;
            }

            cNum.unshift(1,2);
            
            var sum = 0;
            for (var i = 0; i < cNum.length; i += 1) {
                cNum[i] = cNum[i] * c10[i];
                if(cNum[i] > 9) {
                    cNum[i] -= 9;
                }
                sum += cNum[i];
            }

            document.getElementById("chkNum").value = sum % 10;
            lookupGrid();
            
            // document.getElementById("inPole").value = cNum;
            // document.getElementById("inPole").value = cNum[0];
            // document.getElementById("inPole").value = cNum.join("");
            // document.getElementById("customNum").value;
        }

        function lookupGrid() {
            str = document.getElementById("customNum").value;
            <!-- for(var i=0; i < rows.length; i++){ -->
                <!-- if(rows[i].indexOf(str) + 1){ -->
                    <!-- gridTF = rows[i][1]; -->
                    <!-- document.getElementById("inPole").value = "圖號座標:" + gridTF; -->
                    <!-- grid2twd67(); -->
                    <!-- execConvert(); -->
                    <!-- enableBtn(); -->
                    <!-- break; -->
                <!-- } else { -->
                    <!-- disableBtn(); -->
                    <!-- document.getElementById("inPole").value = "無此電號"; -->
                <!-- } -->
            <!-- } -->
			let row = BinSearch(rows, str, 0, rows.length-1);
			if(row + 1) {
			    gridTF = rows[row][1];
			    document.getElementById("inPole").value = gridTF;
				grid2twd67();
                execConvert();
                enableBtn();
		    } else {
			    disableBtn();
				document.getElementById("inPole").value = "無此電號";
			}
	    }

        function grid2twd67() {
            grid = gridTF.toUpperCase();

            var lat = +idxLat[alphabet.indexOf(grid[0])] + +(grid[3]*10 + +grid[4])*500 + +alphabet.indexOf(grid[6])*100 + +grid[8]*10;
            if (grid.length == 11) lat = lat+ +grid[10];
            
            var lon = +idxLon[alphabet.indexOf(grid[0])] + +(grid[1]*10 + +grid[2])*800 + +alphabet.indexOf(grid[5])*100 + +grid[7]*10;
            if (grid.length == 11) lon = lon+ +grid[9];

            latTWD67TM2 = lat;
            lonTWD67TM2 = lon;
        }

        function execConvert() {
            proj4.defs("EPSG:3828", "+proj=tmerc +towgs84=-752,-358,-179,-.0000011698,.0000018398,.0000009822,.00002329 +lat_0=0 +lon_0=121 +x_0=250000 +y_0=0 +k=0.9999 +ellps=aust_SA  +units=公尺");
            proj4.defs("EPSG:3828:Liouciou", "+proj=tmerc +lat_0=0 +lon_0=121 +x_0=249180 +y_0=1590 +k=0.9999 +ellps=aust_SA  +units=公尺");
            var EPSG3828 = new proj4.Proj('EPSG:3828'); //TWD67 121分帶
            var EPSG3828L = new proj4.Proj('EPSG:3828:Liouciou'); //TWD67 121分帶
            var EPSG4326 = new proj4.Proj('EPSG:4326'); //WGS84
            var toProj;
            var grid = document.getElementById('customNum').value.toUpperCase();
            switch(grid[0]){
                case 'T':
                    if((grid.substr(1, 2)<=20) && (grid.substr(3, 2)<=50))
                        toProj=EPSG3828L;
                    else 
                        toProj=EPSG3828; 
                    break;
                default:
                    toProj=EPSG3828; 
            
            }
            var data0 = [Number(lonTWD67TM2), Number(latTWD67TM2)];
            var data1 = proj4(toProj, EPSG4326, data0);
            lonWGS84 = data1[0];
            latWGS84 = data1[1];
            // document.getElementById("inPole").value = latWGS84;
        }

        function disableBtn(){
            document.getElementById("btnOpenGM").disabled = true;
            document.getElementById("btnOpenOSM").disabled = true;
            document.getElementById("btnOpenNLSC").disabled = true;
            document.getElementById("btnOpenLINE").disabled = true;
        }

        function enableBtn(){
            document.getElementById("btnOpenGM").disabled = false;
            document.getElementById("btnOpenOSM").disabled = false;
            document.getElementById("btnOpenNLSC").disabled = false;
            document.getElementById("btnOpenLINE").disabled = false;
        }
        
		function BinSearch(arr, x, start, end) { 
            if (start > end) return -1; 
           
            let mid=Math.floor((start + end)/2); 
            if (arr[mid][0]===x) return mid; 
                  
            if(arr[mid] > x)
                return BinSearch(arr, x, start, mid-1); 
            else
                return BinSearch(arr, x, mid+1, end); 
        }
    </script>
</head>

<body>
	<div id="divForm">
	    <div id="divLogo" onclick="">
		</div>
	    <div id="divInGrid">
        <center>
        <input type="text" value="12" id="districtNum" maxlength="2" size="2"readonly />
        <input type="search" placeholder="用戶電號" id="customNum" maxlength="8" size="11" oninput="calcChkNum();" onchange="calcChkNum();" />
        <input type="text" value="" id="chkNum" maxlength="1" size="1" readonly />
        <!-- <button type="button" class="button" id="btnChk" onclick="" disabled=true></button> -->
        </center>
        </div>

		<div id="divPole">	
        <input type="text" id="inPole" size="11" style="display:'none';" readonly />
        </div>
	
	    <div id="divButton1">
        <button type="button" class="button" id="btnOpenGM" onclick="openGM()" disabled=true></button>
        <button type="button" class="button" id="btnOpenOSM" onclick="openOSM()" disabled=true></button>
        <button type="button" class="button" id="btnOpenNLSC" onclick="openNLSC()" disabled=true></button>
        <button type="button" class="button" id="btnOpenLINE" onclick="openLINE()" disabled=true></button>
        </div>

    <script>
        var rows = [];
        
        document.getElementById("inPole").value = "資料載入中...";

        $.getJSON("custom.json", function(data) {
                rows = data.slice();
        }, )
        .done(function() {
            document.getElementById("inPole").value = "(1091209)";
        });
    </script>
</body>

</html>
